<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" sizes="any">
    <title>Cottage Booking Dashboard</title>
    <!-- Bootstrap 5.4 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="/css/dashboard.css?lkjlaf" rel="stylesheet">
</head>
<body>
<!-- Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Main Content -->
<main class="main-content">
    <div class="dashboard-header">
        <h1 class="h2">Summary</h1>
        <p class="text-muted">Welcome back! Here's what's happening with your cottage bookings today.</p>
    </div>

    <!-- Stats Cards -->
    <div th:replace="~{fragments/stats :: stats}"></div>

    <div class="row">
        <!-- Calendar Section -->
        <div th:replace="~{fragments/calendar :: calendar}"></div>

        <!-- Upcoming Bookings -->
        <div th:replace="~{fragments/upcoming :: upcoming}"></div>
    </div>

    <div class="row">
        <!-- Recent Bookings Table -->
        <div class="col-lg-8 mb-4">
            <div th:replace="~{fragments/recentbookings :: recentbookings}"></div>
        </div>

        <!-- Occupancy Chart -->
        <div class="col-lg-4 mb-4">
            <div th:replace="~{fragments/occupancy :: occupancy}"></div>
        </div>
    </div>
</main>

<!-- Bootstrap & Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="/js/common.js?0980ffafasfasfdasfsasa98jhk"></script>

<script>

    function initDashboard() {
        renderRecentBookings();

    }

    async function renderRecentBookings() {
        const recentBookings = await makeApiRequest('GET', 'http://localhost:8080/api/bookings/recent', {}, false);
        console.log(recentBookings);
        const tbody = document.getElementById('recentBookings');
        let rows = '';
        recentBookings.forEach( b => {
            rows += `
                <tr>
                    <td>${b.customer.name?b.customer.name:b.customer.email}</td>
                    <td>${b.cottage.name}</td>
                    <td>${b.startDate}</td>
                    <td>${b.endDate}</td>
                    <td><span class="badge bg-success">Completed</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-secondary">View</button>
                    </td>
                </tr>
            `;
        });
        tbody.innerHTML = rows;
    }

    async function refreshCalendarFromBE() {
        const bookingData = await makeApiRequest('GET', 'http://localhost:8080/api/bookings/calendar/2025/10', {}, false);
        console.log(bookingData);
        return bookingData;
    }
    // Calendar functionality
    document.addEventListener('DOMContentLoaded', async function() {
        initDashboard();
        // Sample data - in a real app, this would come from a database
        const totalCottages = 12;
        const bookingData = await refreshCalendarFromBE();

        // Check-in/Check-out dates
        const checkInDates = [12, 15, 18, 25];
        const checkOutDates = [15, 18, 22, 28];

        // Generate calendar days
        const calendarDays = document.getElementById('calendar-days');
        const daysInMonth = 31;
        const firstDay = 6; // Saturday - July 1st 2023 is a Saturday

        // Add empty days for the first week
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day';
            calendarDays.appendChild(emptyDay);
        }

        // Add days of the month
        for (let i = 1; i <= daysInMonth; i++) {
            const day = document.createElement('div');
            day.className = 'calendar-day';

            // Add date
            const date = document.createElement('div');
            date.className = 'date';
            date.textContent = i;
            day.appendChild(date);

            // Add availability info if we have data for this day
            if (bookingData[i]) {
                const availability = document.createElement('div');
                availability.className = 'availability';

                const availableSpan = document.createElement('span');
                availableSpan.className = 'available';
                availableSpan.innerHTML = `<span class="availability-dot dot-available"></span> ${bookingData[i].available}`;

                const bookedSpan = document.createElement('span');
                bookedSpan.className = 'booked';
                bookedSpan.innerHTML = `<span class="availability-dot dot-booked"></span> ${bookingData[i].booked}`;

                availability.appendChild(availableSpan);
                availability.appendChild(document.createTextNode(' '));
                availability.appendChild(bookedSpan);

                day.appendChild(availability);

                // Color code based on availability
                const availabilityPercent = (bookingData[i].available / totalCottages) * 100;
                if (availabilityPercent >= 60) {
                    day.classList.add('day-high-availability');
                } else if (availabilityPercent >= 30) {
                    day.classList.add('day-medium-availability');
                } else {
                    day.classList.add('day-low-availability');
                }
            } else {
                // Default to all available if no data
                const availability = document.createElement('div');
                availability.className = 'availability';

                const availableSpan = document.createElement('span');
                availableSpan.className = 'available';
                availableSpan.innerHTML = `<span class="availability-dot dot-available"></span> ${totalCottages}`;

                const bookedSpan = document.createElement('span');
                bookedSpan.className = 'booked';
                bookedSpan.innerHTML = `<span class="availability-dot dot-booked"></span> 0`;

                availability.appendChild(availableSpan);
                availability.appendChild(document.createTextNode(' '));
                availability.appendChild(bookedSpan);

                day.appendChild(availability);
                day.classList.add('day-high-availability');
            }

            // Mark check-in days
            if (checkInDates.includes(i)) {
                day.classList.add('day-checkin');
            }

            // Mark check-out days
            if (checkOutDates.includes(i)) {
                day.classList.add('day-checkout');
            }

            calendarDays.appendChild(day);
        }

        // Occupancy chart
        const ctx = document.getElementById('occupancyChart').getContext('2d');
        const occupancyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [{
                    label: 'Occupancy Rate %',
                    data: [65, 59, 70, 72, 75, 80, 78],
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });

        // Availability chart for next 7 days
        const availCtx = document.getElementById('availabilityChart').getContext('2d');
        const availabilityChart = new Chart(availCtx, {
            type: 'bar',
            data: {
                labels: ['Jul 15', 'Jul 16', 'Jul 17', 'Jul 18', 'Jul 19', 'Jul 20', 'Jul 21'],
                datasets: [
                    {
                        label: 'Available',
                        data: [8, 7, 6, 5, 4, 3, 2],
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                    },
                    {
                        label: 'Booked',
                        data: [4, 5, 6, 7, 8, 9, 10],
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        max: totalCottages
                    }
                }
            }
        });

        // Month navigation
        document.getElementById('prev-month').addEventListener('click', function() {
            alert('Previous month would be shown here');
        });

        document.getElementById('next-month').addEventListener('click', function() {
            alert('Next month would be shown here');
        });
    });
</script>
</body>
</html>