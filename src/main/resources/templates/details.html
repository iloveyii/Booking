<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakeside Paradise - Cottage Details</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" sizes="any">
    <!-- Bootstrap 5.4 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/details.css?iiihi8rsfsfewyfas98979" rel="stylesheet">
    <link href="/css/styles.css?ljsflffasf" rel="stylesheet">
    <link href="/css/booking.css" rel="stylesheet">
</head>
<body>
<!-- Header Navigation -->
<header th:replace="~{fragments/navigation :: navigation}"></header>

<!-- Details Page Header  -->
<div class="cottage-header text-center">
    <div class="container">
        <h1 class="display-4" id="heading">Seaside Villa</h1>
        <p class="lead" id="lead">Luxury beachfront cottage with panoramic ocean views</p>
    </div>
</div>

<!-- Main Content -->
<main class="container">
    <!-- Breadcrumb -->
    <div class="breadcrumb mx-1 mx-md-3 mx-lg-1">
        <a href="#">Home</a> > <a href="#">Ontario</a> > <a href="#">Muskoka</a> > Lakeside Paradise
    </div>

    <!-- Cottage Details -->
    <div class="cottage-details mx-1 mx-md-3 mx-lg-1">
        <div class="cottage-content">
            <!-- Image Gallery -->
            <div class="gallery" th:replace="~{fragments/gallery :: gallery}"></div>

            <!-- Cottage Information -->
            <div class="cottage-info" th:replace="~{fragments/cottageinfo :: cottageinfo}"></div>

            <!-- Amenities Section -->
            <div class="amenities" th:replace="~{fragments/amenities :: amenities}"></div>

            <!-- Reviews Section -->
            <div class="reviews" th:replace="~{fragments/reviews :: reviews}"></div>
        </div>

        <!-- Booking Form -->
        <div class="bookingform" th:replace="~{fragments/bookingform :: bookingform}"></div>
    </div>
</main>

<!-- Footer -->
<footer th:replace="~{fragments/footer :: footer}"></footer>

<!-- Modal -->
<div th:replace="~{fragments/modal :: modal}" class="modal fade pdf-modal" id="pdfModal" tabindex="-1" aria-hidden="true"></div>
<!-- Floating notifications -->
<div th:replace="~{fragments/notification :: notification}"></div>

<!-- Bootstrap & Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="/js/common.js?0980ffafasffasasfdasfsasa98jhk"></script>
<script src="/js/calendar.js?khk09880hkhk"></script>
<script>
    document.addEventListener('DOMContentLoaded', async function() {

        renderDetails();
        refreshCalendarFromBE();
        document.getElementById('guests-container').appendChild(getGuestSelectElement(2, 5));

        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
          e.preventDefault();

          const checkIn = document.getElementById('checkInDate').value;
          const checkOut = document.getElementById('checkOutDate').value;
          const guests = document.getElementById('guests').value;
          const email = document.getElementById('email').value;
          const specialRequests = document.getElementById('specialRequests').value;

          if (!checkIn || !checkOut) {
              showNotification('Please select both check-in and check-out dates');
              return;
          }

          if (!email) {
            showNotification('Please enter a valid email');
            return;
          }

          if (new Date(checkIn) > new Date(checkOut)) {
              showNotification('Check-out date must be after check-in date');
              return;
          }

          // In a real application, you would submit the booking here
          console.log(`Booking request received!\nCheck-in: ${checkIn}\nCheck-out: ${checkOut}\nGuests: ${guests}\nEmail: ${email}\nSpecial Requests: ${specialRequests}`);
          doBooking(checkIn, checkOut, guests, email, specialRequests);
        });
    });

    async function refreshCalendarFromBE() {
        const id = window.location.pathname.split("/").pop();
        const availableDates = await makeApiRequest('GET', '/api/availabilities/' + id, {}, false);
        console.log(availableDates);
        getCalendar(availableDates, '#checkInDate', '#checkOutDate');
        document.getElementById('checkInDate').value = '';
        document.getElementById('checkOutDate').value = '';
    }

    async function renderDetails() {
        const id = window.location.pathname.split("/").pop();
        const cottage = await makeApiRequest('GET', '/api/cottages/' + id, {}, false);
        console.log(cottage);
        if(cottage) {
            document.title = `${cottage.name} - Cottage Details ðŸš€`;
            document.getElementById('heading').innerHTML = cottage.name;
            document.getElementById('price').innerHTML = '$' + cottage.pricePerNight;
            document.getElementById('galleryMain').innerHTML = `<img src="/images/${cottage.images[0]}" alt="${cottage.name}" id="main-image">`;
            const gallery = document.getElementById('gallery');
            let images = cottage.images; // .slice(1);
            if(images.length == 0) images = cottage.images;
            images.forEach(item => {
                console.log(item);
                const div = document.createElement('div');
                div.className = 'gallery-thumb';
                div.innerHTML = `<img src="/images/${item}" alt="Cottage Exterior">`;
                gallery.appendChild(div);
            });
        }
    }

    async function doBooking(startDate, endDate, guests, email, specialRequests) {
        const submitBooking = document.getElementById('submitBooking');
        const origText = submitBooking.innerHTML;
        submitBooking.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Book Now';
        submitBooking.disabled = true;
        const cottageId = window.location.pathname.split("/").pop();
        const resp = await makeApiRequest('POST', '/api/bookings', {cottageId, startDate, endDate, guests, email, specialRequests}, false);
        if(resp && resp.id) {
            openInfoModal(resp.id, startDate, endDate, guests, email);
            refreshCalendarFromBE();
        } else {
            alert(resp);
        }

        setTimeout(() => {submitBooking.innerHTML = origText; submitBooking.disabled=false;}, 3000);
    }

    function openInfoModal(bookingId, startDate, endDate, guests, email) {
        const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
        infoModal.show();
        addConfettiParticles('confetti-container');
        renderModelContent(bookingId, startDate, endDate, guests, email);
    }

    function renderModelContent(bookingId, startDate, endDate, guests, email) {
        document.getElementById('bookingEmail').innerHTML = `${bookingId}`;
        document.getElementById('bookingDates').innerHTML = `${startDate} - ${endDate}`;
        document.getElementById('bookingGuests').innerHTML = `${guests} Adults`;
        document.getElementById('bookingEmail').innerHTML = `${email}`;
    }
</script>
</body>
</html>